name: ci-strict

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  strict:
    runs-on: ubuntu-latest
    env:
      STRICT_MODE: "1"
    steps:
      - uses: actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633 # v4.1.2

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"

      - name: Admin audit pattern check
        run: python backend/scripts/check_admin_patterns.py

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          cd backend
          pip install -r requirements.lock
          pip install pytest httpx pytest-asyncio pytest-cov pip-audit bandit
          alembic upgrade head

      - name: Backend full suite
        run: |
          ./scripts/test-backend.sh

      - name: pip-audit (backend)
        run: |
          cd backend
          # python-ecdsa Minerva timing attack (CVE-2024-23342 / GHSA-wj6h-64fc-37mp)
          # Safe to ignore here: this service uses HS256 JWT (no ECDSA signing); ecdsa is only transitive.
          pip-audit -r requirements.lock --strict --ignore-vuln CVE-2024-23342 --ignore-vuln GHSA-wj6h-64fc-37mp --ignore-vuln CVE-2026-21441

      - name: Bandit (backend)
        run: |
          cd backend
          bandit -r app -x tests

      - name: Build backend image
        run: |
          docker build -t rag-backend:ci backend

      - name: Trivy image scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: rag-backend:ci
          severity: CRITICAL,HIGH
          ignore-unfixed: true

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "18"

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Frontend tests + build
        run: |
          ./scripts/test-frontend.sh

      - name: Frontend audit
        run: |
          cd frontend
          npm audit --production --audit-level=high

      - name: SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0
        with:
          output-file: sbom.spdx.json
          format: spdx-json
